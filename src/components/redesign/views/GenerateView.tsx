import React, { useState } from 'react'
import {
  Box,
  Typography,
  Card,
  CardContent,
  TextField,
  Button,
  Grid,
  Alert,
  Chip,
  Divider,
  LinearProgress,
  Stepper,
  Step,
  StepLabel,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  List,
  ListItem,
  ListItemText,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  useTheme
} from '@mui/material'
import {
  Build,
  FileDownload,
  Settings,
  ExpandMore,
  CheckCircle,
  Warning,
  Info
} from '@mui/icons-material'
import { MINECRAFT_VERSIONS, getRecommendedVersion, getPackFormatHelperText } from '../../../utils/minecraftVersions'

interface GenerateViewProps {
  files: any[]
  translatedEntries: any[]
  onGenerateResourcePack: (options: any) => void
  onNotification: (message: string, severity: 'success' | 'error' | 'warning' | 'info') => void
}

const GenerateView: React.FC<GenerateViewProps> = ({
  files,
  translatedEntries,
  onGenerateResourcePack,
  onNotification
}) => {
  const theme = useTheme()
  const [packName, setPackName] = useState('My Language Pack')
  const [packDescription, setPackDescription] = useState('Generated by LangPack Studio')
  const [packFormat, setPackFormat] = useState(getRecommendedVersion().packFormat)
  const [isGenerating, setIsGenerating] = useState(false)
  const [generationProgress, setGenerationProgress] = useState(0)

  const handleGenerate = async () => {
    setIsGenerating(true)
    setGenerationProgress(0)

    // Simulate progress
    const progressInterval = setInterval(() => {
      setGenerationProgress(prev => Math.min(prev + 10, 90))
    }, 200)

    try {
      const options = {
        packName,
        description: packDescription,
        packFormat,
        includeTranslations: translatedEntries.length > 0 ? translatedEntries : undefined
      }

      await onGenerateResourcePack(options)
      setGenerationProgress(100)
    } catch (error) {
      onNotification('ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
    } finally {
      clearInterval(progressInterval)
      setIsGenerating(false)
    }
  }

  const getFileStats = () => {
    const jsonFiles = files.filter(f => f.type === 'json' || f.name.endsWith('.json'))
    const langFiles = files.filter(f => f.type === 'lang' || f.name.endsWith('.lang'))
    
    return { jsonFiles: jsonFiles.length, langFiles: langFiles.length }
  }

  const stats = getFileStats()

  if (files.length === 0) {
    return (
      <Box sx={{ textAlign: 'center', py: 8 }}>
        <Build sx={{ fontSize: 80, color: 'text.disabled', mb: 2 }} />
        <Typography variant="h5" color="text.secondary" gutterBottom>
          ç”Ÿæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“
        </Typography>
        <Typography variant="body1" color="text.disabled">
          ã¾ãšè¨€èªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„
        </Typography>
      </Box>
    )
  }

  return (
    <Box>
      {/* Header */}
      <Box sx={{ mb: 4 }}>
        <Typography variant="h4" sx={{ fontWeight: 600, mb: 1 }}>
          ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ç”Ÿæˆ
        </Typography>
        <Typography variant="body1" color="text.secondary">
          Minecraftç”¨ã®ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ã‚’ç”Ÿæˆã—ã¾ã™
        </Typography>
      </Box>

      <Grid container spacing={3}>
        {/* Configuration */}
        <Grid item xs={12} md={6}>
          <Card>
            <CardContent>
              <Typography variant="h6" gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                <Settings />
                ãƒ‘ãƒƒã‚¯è¨­å®š
              </Typography>
              
              <TextField
                fullWidth
                label="ãƒ‘ãƒƒã‚¯å"
                value={packName}
                onChange={(e) => setPackName(e.target.value)}
                sx={{ mb: 2 }}
              />
              
              <TextField
                fullWidth
                label="èª¬æ˜"
                value={packDescription}
                onChange={(e) => setPackDescription(e.target.value)}
                multiline
                rows={2}
                sx={{ mb: 2 }}
              />
              
              <FormControl fullWidth sx={{ mb: 2 }}>
                <InputLabel>Minecraftãƒãƒ¼ã‚¸ãƒ§ãƒ³</InputLabel>
                <Select
                  value={packFormat}
                  onChange={(e) => setPackFormat(Number(e.target.value))}
                  label="Minecraftãƒãƒ¼ã‚¸ãƒ§ãƒ³"
                >
                  {MINECRAFT_VERSIONS.map((version) => (
                    <MenuItem key={version.packFormat} value={version.packFormat}>
                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, width: '100%' }}>
                        <Typography variant="body2" sx={{ flexGrow: 1 }}>
                          {version.displayName}
                        </Typography>
                        <Chip 
                          label={`PF:${version.packFormat}`} 
                          size="small" 
                          variant="outlined"
                          color={version.isRecommended ? "primary" : "default"}
                        />
                        {version.isRecommended && (
                          <Chip 
                            label="æ¨å¥¨" 
                            size="small" 
                            color="success"
                          />
                        )}
                      </Box>
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
              
              <Alert severity="info" sx={{ mt: 1 }}>
                <Typography variant="body2">
                  {getPackFormatHelperText(packFormat)}
                </Typography>
              </Alert>
            </CardContent>
          </Card>

          {/* Generation Process */}
          <Card sx={{ mt: 2 }}>
            <CardContent>
              <Typography variant="h6" gutterBottom>
                ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹
              </Typography>
              
              <Stepper orientation="vertical">
                <Step completed>
                  <StepLabel>ãƒ•ã‚¡ã‚¤ãƒ«è§£æ</StepLabel>
                </Step>
                <Step completed>
                  <StepLabel>ãƒ‡ãƒ¼ã‚¿å¤‰æ›</StepLabel>
                </Step>
                <Step active={isGenerating}>
                  <StepLabel>ZIPåœ§ç¸®</StepLabel>
                </Step>
                <Step>
                  <StepLabel>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</StepLabel>
                </Step>
              </Stepper>

              {isGenerating && (
                <Box sx={{ mt: 2 }}>
                  <Typography variant="body2" color="text.secondary" gutterBottom>
                    ç”Ÿæˆä¸­... {generationProgress}%
                  </Typography>
                  <LinearProgress 
                    variant="determinate" 
                    value={generationProgress}
                    sx={{ height: 8, borderRadius: 4 }}
                  />
                </Box>
              )}
            </CardContent>
          </Card>
        </Grid>

        {/* Preview & Stats */}
        <Grid item xs={12} md={6}>
          <Card>
            <CardContent>
              <Typography variant="h6" gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                <Info />
                ç”Ÿæˆå†…å®¹
              </Typography>

              {/* File Summary */}
              <Box sx={{ mb: 3 }}>
                <Typography variant="subtitle2" gutterBottom>
                  ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
                </Typography>
                <Box sx={{ display: 'flex', gap: 1, mb: 2 }}>
                  <Chip 
                    label={`${stats.jsonFiles} JSONãƒ•ã‚¡ã‚¤ãƒ«`} 
                    color="primary" 
                    variant="outlined"
                    size="small"
                  />
                  <Chip 
                    label={`${stats.langFiles} LANGãƒ•ã‚¡ã‚¤ãƒ«`} 
                    color="secondary" 
                    variant="outlined"
                    size="small"
                  />
                </Box>

                {translatedEntries.length > 0 && (
                  <>
                    <Typography variant="subtitle2" gutterBottom>
                      ç¿»è¨³ãƒ‡ãƒ¼ã‚¿
                    </Typography>
                    <Chip 
                      label={`${translatedEntries.length} ç¿»è¨³ã‚¨ãƒ³ãƒˆãƒªãƒ¼`} 
                      color="success" 
                      variant="outlined"
                      size="small"
                    />
                  </>
                )}
              </Box>

              <Divider sx={{ mb: 2 }} />

              {/* Output Structure Preview */}
              <Typography variant="subtitle2" gutterBottom>
                ç”Ÿæˆã•ã‚Œã‚‹æ§‹é€ 
              </Typography>
              <Box 
                sx={{ 
                  bgcolor: 'action.hover', 
                  p: 2, 
                  borderRadius: 2,
                  fontFamily: 'monospace',
                  fontSize: '0.875rem',
                  mb: 2
                }}
              >
                <div>ğŸ“¦ {packName.replace(/\s+/g, '-').toLowerCase()}.zip</div>
                <div>â”œâ”€â”€ ğŸ“„ pack.mcmeta</div>
                <div>â””â”€â”€ ğŸ“ assets/</div>
                <div>&nbsp;&nbsp;&nbsp;&nbsp;â””â”€â”€ ğŸ“ [modid]/</div>
                <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;â””â”€â”€ ğŸ“ lang/</div>
                <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;â”œâ”€â”€ ğŸ“„ en_us.json</div>
                {translatedEntries.length > 0 && (
                  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;â””â”€â”€ ğŸ“„ ja_jp.json</div>
                )}
              </Box>

              {/* Warnings */}
              {translatedEntries.length === 0 && (
                <Alert severity="warning" sx={{ mb: 2 }}>
                  ç¿»è¨³ã•ã‚ŒãŸã‚¨ãƒ³ãƒˆãƒªãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã§ãƒ‘ãƒƒã‚¯ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
                </Alert>
              )}

              {/* Generate Button */}
              <Button
                fullWidth
                variant="contained"
                size="large"
                startIcon={isGenerating ? <Build /> : <FileDownload />}
                onClick={handleGenerate}
                disabled={isGenerating}
                sx={{
                  py: 1.5,
                  fontSize: '1.1rem',
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  '&:hover': {
                    background: 'linear-gradient(135deg, #764ba2 0%, #667eea 100%)',
                  },
                }}
              >
                {isGenerating ? 'ãƒ‘ãƒƒã‚¯ç”Ÿæˆä¸­...' : 'ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ã‚’ç”Ÿæˆ'}
              </Button>
            </CardContent>
          </Card>

          {/* Advanced Options */}
          <Accordion sx={{ mt: 2 }}>
            <AccordionSummary expandIcon={<ExpandMore />}>
              <Typography variant="subtitle1">é«˜åº¦ãªè¨­å®š</Typography>
            </AccordionSummary>
            <AccordionDetails>
              <List dense>
                <ListItem>
                  <ListItemText
                    primary="ãƒ•ã‚¡ã‚¤ãƒ«åœ§ç¸®"
                    secondary="ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®åœ§ç¸®ãƒ¬ãƒ™ãƒ«: æ¨™æº–"
                  />
                </ListItem>
                <ListItem>
                  <ListItemText
                    primary="æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°"
                    secondary="UTF-8 (Minecraftæ¨™æº–)"
                  />
                </ListItem>
                <ListItem>
                  <ListItemText
                    primary="äº’æ›æ€§ãƒã‚§ãƒƒã‚¯"
                    secondary="ãƒ‘ãƒƒã‚¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨Minecraftãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ¤œè¨¼"
                  />
                </ListItem>
              </List>
            </AccordionDetails>
          </Accordion>
        </Grid>
      </Grid>
    </Box>
  )
}

export default GenerateView